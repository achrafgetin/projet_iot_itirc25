{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4 display-4">Graphique d'Humidité</h1>

    <!-- Boutons pour filtrer les données -->
    <div class="btn-toolbar mb-4 justify-content-center">
        <div class="btn-group">
            <button id="aujourdhui-link" class="btn btn-outline-primary">
                <i class="fas fa-calendar-day me-2"></i> Aujourd'hui
            </button>
            <button id="semaine-link" class="btn btn-outline-primary">
                <i class="fas fa-calendar-week me-2"></i> Cette Semaine
            </button>
            <button id="mois-link" class="btn btn-outline-primary">
                <i class="fas fa-calendar-alt me-2"></i> Ce Mois
            </button>
        </div>
    </div>

    <!-- Graphique -->
    <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-primary text-white">
            <h5 class="card-title mb-0"><i class="fas fa-tint me-2"></i> Humidité (%)</h5>
        </div>
        <div class="card-body">
            <!-- Boutons de zoom -->
            <div class="d-flex justify-content-end mb-3">
                <button id="zoom-in" class="btn btn-outline-primary btn-sm me-2">
                    <i class="fas fa-search-plus"></i> Zoom +
                </button>
                <button id="zoom-out" class="btn btn-outline-primary btn-sm me-2">
                    <i class="fas fa-search-minus"></i> Zoom -
                </button>
                <button id="reset-zoom" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-sync-alt"></i> Réinitialiser
                </button>
            </div>
            <!-- Graphique -->
            <canvas class="my-4 w-100" id="graphique-hum" height="400"></canvas>
        </div>
    </div>
</div>

<!-- Scripts pour Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.3.0/dist/chartjs-plugin-zoom.min.js"></script>

<!-- Script pour initialiser le graphique -->
<script>
    const createChart = (url, borderWidth) => {
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const labels = data.temps;
                const dataValues = data.humidity;
                const ctx = document.getElementById('graphique-hum').getContext('2d');
                window.myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Humidité (%)',
                            data: dataValues,
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: borderWidth,
                            pointRadius: 3,
                            pointBackgroundColor: 'rgba(40, 167, 69, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Humidité (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Temps'
                                }
                            }
                        },
                        plugins: {
                            zoom: {
                                zoom: {
                                    wheel: {
                                        enabled: true,
                                        speed: 0.1,
                                        modifierKey: 'ctrl',
                                    },
                                    pinch: {
                                        enabled: true
                                    },
                                    mode: 'xy',
                                },
                                pan: {
                                    enabled: true,
                                    mode: 'xy',
                                }
                            }
                        }
                    }
                });
            });
    };

    // Écouteurs d'événements pour les boutons
    document.getElementById('aujourdhui-link').addEventListener('click', () => createChart('/chart-data-jour/', 2));
    document.getElementById('semaine-link').addEventListener('click', () => createChart('/chart-data-semaine/', 2));
    document.getElementById('mois-link').addEventListener('click', () => createChart('/chart-data-mois/', 2));

    // Fonction pour zoomer
    document.getElementById('zoom-in').addEventListener('click', () => {
        if (window.myChart) {
            const xScale = window.myChart.scales.x;
            const yScale = window.myChart.scales.y;

            // Calculer les nouvelles limites pour zoomer
            const xRange = xScale.max - xScale.min;
            const yRange = yScale.max - yScale.min;
            const zoomFactor = 0.9; // Zoom in de 10%

            xScale.options.min = xScale.min + xRange * (1 - zoomFactor) / 2;
            xScale.options.max = xScale.max - xRange * (1 - zoomFactor) / 2;
            yScale.options.min = yScale.min + yRange * (1 - zoomFactor) / 2;
            yScale.options.max = yScale.max - yRange * (1 - zoomFactor) / 2;

            window.myChart.update(); // Mettre à jour le graphique
        }
    });

    // Fonction pour dézoomer
    document.getElementById('zoom-out').addEventListener('click', () => {
        if (window.myChart) {
            const xScale = window.myChart.scales.x;
            const yScale = window.myChart.scales.y;

            // Calculer les nouvelles limites pour dézoomer
            const xRange = xScale.max - xScale.min;
            const yRange = yScale.max - yScale.min;
            const zoomFactor = 1.1; // Zoom out de 10%

            xScale.options.min = xScale.min - xRange * (zoomFactor - 1) / 2;
            xScale.options.max = xScale.max + xRange * (zoomFactor - 1) / 2;
            yScale.options.min = yScale.min - yRange * (zoomFactor - 1) / 2;
            yScale.options.max = yScale.max + yRange * (zoomFactor - 1) / 2;

            window.myChart.update(); // Mettre à jour le graphique
        }
    });

    // Fonction pour réinitialiser le zoom
    document.getElementById('reset-zoom').addEventListener('click', () => {
        if (window.myChart) {
            // Réinitialiser les limites des axes
            window.myChart.options.scales.x.min = null;
            window.myChart.options.scales.x.max = null;
            window.myChart.options.scales.y.min = null;
            window.myChart.options.scales.y.max = null;
            window.myChart.update(); // Mettre à jour le graphique
        }
    });

    // Charge initiale du graphique
    createChart('/chart-data/', 2);
</script>

<!-- Styles CSS personnalisés -->
<style>
    body {
        background-color: #f8f9fa;
        font-family: 'Roboto', sans-serif;
    }

    .card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        border-radius: 15px 15px 0 0;
        background: linear-gradient(45deg, #007bff, #00bcd4);
    }

    .btn-outline-primary {
        border-color: #007bff;
        color: #007bff;
        transition: all 0.3s ease;
    }

    .btn-outline-primary:hover {
        background-color: #007bff;
        color: #fff;
    }

    .btn-outline-secondary {
        border-color: #6c757d;
        color: #6c757d;
        transition: all 0.3s ease;
    }

    .btn-outline-secondary:hover {
        background-color: #6c757d;
        color: #fff;
    }
</style>
{% endblock %}